<div class="course-editor-container">
  <!-- Loading/Error State -->
  @if (!course() && !error()) {
    <div class="loading-card">
      <app-icon name="arrow-path" size="xl" class="spin" />
      <p>Đang tải khóa học...</p>
    </div>
  }

  @if (error() && !course()) {
    <div class="error-card">
      <app-icon name="exclamation-circle" size="xl" />
      <h3>Không thể tải khóa học</h3>
      <p>{{ error() }}</p>
      <app-button variant="ghost" [routerLink]="['/teacher/courses']">
        <app-icon name="arrow-left" size="sm" />
        Quay lại danh sách
      </app-button>
    </div>
  }

  <!-- Main Content -->
  @if (course(); as c) {
    <!-- Header -->
    <div class="page-header">
      <div class="header-left">
        <h1 class="page-title">Chỉnh sửa khóa học</h1>
        <p class="page-subtitle">{{ c.code }} - {{ c.title }}</p>
      </div>
      <app-button variant="ghost" [routerLink]="['/teacher/courses']">
        <app-icon name="arrow-left" size="sm" />
        Quay lại
      </app-button>
    </div>

    <!-- Accordion Sections -->
    <div class="accordion-container">
      
      <!-- Section 1: Course Info -->
      <div class="accordion-item" [class.expanded]="accordionState.courseInfo">
        <button 
          type="button"
          class="accordion-header" 
          (click)="toggleAccordion('courseInfo')">
          <div class="header-left">
            <app-icon name="pencil" size="md" class="header-icon" />
            <h2 class="accordion-title">Thông tin khóa học</h2>
          </div>
          <app-icon 
            [name]="accordionState.courseInfo ? 'chevron-up' : 'chevron-down'" 
            size="sm" 
            class="chevron-icon" />
        </button>

        @if (accordionState.courseInfo) {
          <div class="accordion-content">
            <form [formGroup]="form" (ngSubmit)="onSave()" class="form-content">
        <!-- Course Code -->
        <div class="form-group">
          <label class="form-label" for="code">Mã khóa học</label>
          <input 
            id="code"
            formControlName="code" 
            type="text" 
            class="form-input"
            placeholder="VD: ME101" />
        </div>

        <!-- Course Title -->
        <div class="form-group">
          <label class="form-label" for="title">Tên khóa học</label>
          <input 
            id="title"
            formControlName="title" 
            type="text" 
            class="form-input"
            placeholder="Tên khóa học" />
        </div>

        <!-- Course Description -->
        <div class="form-group">
          <label class="form-label" for="description">Mô tả</label>
          <textarea 
            id="description"
            formControlName="description" 
            rows="6" 
            class="form-textarea"
            placeholder="Mô tả chi tiết về khóa học..."></textarea>
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <app-button 
            type="submit"
            variant="primary"
            [disabled]="form.invalid || saving()">
            @if (saving()) {
              <app-icon name="arrow-path" size="sm" class="spin" />
            }
            <span>{{ saving() ? 'Đang lưu...' : 'Lưu thay đổi' }}</span>
          </app-button>

          <app-button 
            type="button"
            variant="primary"
            [disabled]="publishing()"
            (clicked)="onPublish()">
            @if (publishing()) {
              <app-icon name="arrow-path" size="sm" class="spin" />
            }
            <span>{{ publishing() ? 'Đang xuất bản...' : 'Xuất bản' }}</span>
          </app-button>
        </div>

        <!-- Messages -->
        @if (success()) {
          <div class="success-alert">
            <app-icon name="check-circle" size="sm" />
            <span>{{ success() }}</span>
          </div>
        }

        @if (error()) {
          <div class="error-alert">
            <app-icon name="exclamation-circle" size="sm" />
            <span>{{ error() }}</span>
          </div>
        }
            </form>
          </div>
        }
      </div>

      <!-- Section 2: Course Content -->
      <div class="accordion-item" [class.expanded]="accordionState.courseContent">
        <button 
          type="button"
          class="accordion-header" 
          (click)="toggleAccordion('courseContent')">
          <div class="header-left">
            <app-icon name="book-open" size="md" class="header-icon" />
            <h2 class="accordion-title">Nội dung khóa học</h2>
          </div>
          <app-icon 
            [name]="accordionState.courseContent ? 'chevron-up' : 'chevron-down'" 
            size="sm" 
            class="chevron-icon" />
        </button>

        @if (accordionState.courseContent) {
          <div class="accordion-content">

      <!-- Create Section Bar -->
      <div class="create-section-bar">
        <input 
          class="section-input" 
          placeholder="Tiêu đề chương (VD: Chương 1: Giới thiệu)"
          [(ngModel)]="newSectionTitle" />
        <app-button variant="primary" (clicked)="createSection()">
          <app-icon name="plus" size="sm" />
          Tạo chương
        </app-button>
      </div>

      @if (sectionError) {
        <div class="error-alert">
          <app-icon name="exclamation-circle" size="sm" />
          <span>{{ sectionError }}</span>
        </div>
      }

      <!-- Sections List -->
      @if (sections().length === 0) {
        <div class="empty-state">
          <app-icon name="book-open" size="xl" />
          <h3>Chưa có chương nào</h3>
          <p>Tạo chương đầu tiên để thêm bài học vào khóa học</p>
        </div>
      } @else {
        <!-- Sections List with Expandable Lessons -->
        <div class="sections-list">
          @for (sec of sections(); track sec.id; let i = $index) {
            <div class="section-item">
              <!-- Section Header -->
              <div class="section-header">
                <div class="section-info">
                  <span class="section-number">{{ i + 1 }}</span>
                  <input 
                    class="section-title-input" 
                    [ngModel]="sectionTitles[sec.id]" 
                    (ngModelChange)="sectionTitles[sec.id] = $event"
                    (blur)="renameSection(sec.id)"
                    placeholder="Nhập tên chương"/>
                  <span class="lesson-count-badge">{{ sec.lessonCount || 0 }} bài học</span>
                </div>
                
                <div class="section-actions">
                  <app-button 
                    variant="ghost" 
                    size="sm"
                    (clicked)="toggleSection(sec.id)">
                    <app-icon [name]="expandedSections[sec.id] ? 'chevron-up' : 'chevron-down'" size="xs" />
                    {{ expandedSections[sec.id] ? 'Thu gọn' : 'Xem bài học' }}
                  </app-button>
                  <app-button 
                    variant="outline" 
                    size="sm"
                    class="btn-delete"
                    (clicked)="deleteSection(sec.id)">
                    <app-icon name="x-circle" size="xs" />
                    Xóa chương
                  </app-button>
                </div>
              </div>

              <!-- Lessons (Expandable) -->
              @if (expandedSections[sec.id]) {
                <div class="lessons-container">
                  <!-- Add Lesson Button -->
                  @if (!showLessonForm[sec.id]) {
                    <div class="add-lesson-bar">
                      <app-button 
                        variant="primary" 
                        size="sm"
                        (clicked)="openLessonForm(sec.id)">
                        <app-icon name="plus" size="xs" />
                        Thêm bài học
                      </app-button>
                    </div>
                  }

                  <!-- Lesson Form -->
                  @if (showLessonForm[sec.id]) {
                    <div class="lesson-form-card">
                      <div class="lesson-form-header">
                        <h4>{{ editingLesson[sec.id] ? 'Chỉnh sửa bài học' : 'Tạo bài học mới' }}</h4>
                        <button class="close-btn" (click)="closeLessonForm(sec.id)">
                          <app-icon name="x-mark" size="xs" />
                        </button>
                      </div>
                      
                      <form [formGroup]="lessonForms[sec.id]" class="lesson-form">
                        <div class="form-row">
                          <div class="form-group">
                            <label>Loại bài học</label>
                            <select formControlName="lessonType" class="form-select" [disabled]="!!editingLesson[sec.id]">
                              <option value="LECTURE">Bài giảng</option>
                              <option value="ASSIGNMENT">Bài tập</option>
                              <option value="QUIZ">Trắc nghiệm</option>
                            </select>
                          </div>
                        </div>

                        <div class="form-group">
                          <label>Tiêu đề *</label>
                          <input formControlName="title" type="text" class="form-input" placeholder="Tên bài học" />
                        </div>

                        <div class="form-group">
                          <label>Mô tả</label>
                          <textarea formControlName="description" rows="2" class="form-textarea" placeholder="Mô tả ngắn"></textarea>
                        </div>

                        @if (lessonForms[sec.id]?.get('lessonType')?.value === 'LECTURE') {
                          <div class="form-group">
                            <label>Video URL</label>
                            <input formControlName="videoUrl" type="url" class="form-input" placeholder="https://youtube.com/..." />
                          </div>
                        }

                        <div class="form-group">
                          <label>Nội dung</label>
                          <textarea formControlName="content" rows="4" class="form-textarea" placeholder="Nội dung chi tiết"></textarea>
                        </div>

                        <div class="form-actions">
                          <app-button 
                            variant="primary" 
                            size="sm"
                            [disabled]="lessonForms[sec.id]?.invalid"
                            (clicked)="saveLesson(sec.id)">
                            {{ editingLesson[sec.id] ? 'Cập nhật' : 'Tạo bài học' }}
                          </app-button>
                          <app-button 
                            variant="ghost" 
                            size="sm"
                            (clicked)="closeLessonForm(sec.id)">
                            Hủy
                          </app-button>
                        </div>
                      </form>
                    </div>
                  }

                  <!-- Loading Lessons -->
                  @if (loadingLessons[sec.id]) {
                    <div class="lessons-loading">
                      <app-icon name="arrow-path" size="md" class="spin" />
                      <span>Đang tải bài học...</span>
                    </div>
                  }

                  <!-- Lessons List -->
                  @if (!loadingLessons[sec.id] && sectionLessons[sec.id] && sectionLessons[sec.id].length > 0) {
                    <div class="lessons-list">
                      @for (lesson of sectionLessons[sec.id]; track lesson.id; let j = $index) {
                        <div class="lesson-item">
                          <div class="lesson-info">
                            <span class="lesson-number">{{ j + 1 }}</span>
                            <div class="lesson-details">
                              <div class="lesson-title">{{ lesson.title }}</div>
                              @if (lesson.description) {
                                <div class="lesson-description">{{ lesson.description }}</div>
                              }
                            </div>
                            <app-badge [variant]="getLessonTypeBadgeVariant(lesson.lessonType)" size="sm">
                              {{ getLessonTypeLabel(lesson.lessonType) }}
                            </app-badge>
                          </div>
                          <div class="lesson-actions">
                            <app-button 
                              variant="ghost" 
                              size="sm"
                              (clicked)="openLessonForm(sec.id, lesson)">
                              <app-icon name="pencil" size="xs" />
                            </app-button>
                            <app-button 
                              variant="ghost" 
                              size="sm"
                              class="btn-delete"
                              (clicked)="deleteLesson(sec.id, lesson.id)">
                              <app-icon name="x-circle" size="xs" />
                            </app-button>
                          </div>
                        </div>
                      }
                    </div>
                  }

                  <!-- Empty Lessons -->
                  @if (!loadingLessons[sec.id] && (!sectionLessons[sec.id] || sectionLessons[sec.id]?.length === 0)) {
                    <div class="lessons-empty">
                      <app-icon name="book-open" size="md" />
                      <p>Chưa có bài học nào. Click "Thêm bài học" để tạo bài học đầu tiên.</p>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
          </div>
        }
      </div>

      <!-- Section 3: Student Assignment -->
      <div class="accordion-item" [class.expanded]="accordionState.studentAssignment">
        <button 
          type="button"
          class="accordion-header" 
          (click)="toggleAccordion('studentAssignment')">
          <div class="header-left">
            <app-icon name="users" size="md" class="header-icon" />
            <h2 class="accordion-title">Gán học viên</h2>
          </div>
          <app-icon 
            [name]="accordionState.studentAssignment ? 'chevron-up' : 'chevron-down'" 
            size="sm" 
            class="chevron-icon" />
        </button>

        @if (accordionState.studentAssignment) {
          <div class="accordion-content">
        <!-- Single Assignment -->
        <div class="assignment-section">
          <h3 class="section-subtitle">Gán từng học viên</h3>
          <div class="assignment-form">
            <input 
              [(ngModel)]="assign.email"
              type="email" 
              class="form-input"
              placeholder="email@example.com" />
            <app-button 
              variant="primary"
              [disabled]="assigning() || !assign.email?.trim()"
              (clicked)="assignStudent()">
              @if (assigning()) {
                <app-icon name="arrow-path" size="sm" class="spin" />
              }
              <span>{{ assigning() ? 'Đang gán...' : 'Gán học viên' }}</span>
            </app-button>
          </div>

          @if (assignSuccess()) {
            <div class="success-alert">
              <app-icon name="check-circle" size="sm" />
              <span>{{ assignSuccess() }}</span>
            </div>
          }

          @if (assignError()) {
            <div class="error-alert">
              <app-icon name="exclamation-circle" size="sm" />
              <span>{{ assignError() }}</span>
            </div>
          }
        </div>

        <!-- Bulk Assignment -->
        <div class="assignment-section">
          <h3 class="section-subtitle">Gán nhiều học viên bằng Excel</h3>
          
          <div class="file-upload-area">
            <input 
              type="file" 
              #fileInput 
              (change)="onExcelFileSelected($event)" 
              accept=".xlsx,.xls"
              class="file-input" 
              id="excelFile" />
            <label for="excelFile" class="file-label">
              <app-icon name="document-text" size="md" />
              <span>Chọn file Excel (.xlsx, .xls)</span>
            </label>
          </div>

          @if (selectedFile()) {
            <div class="file-info">
              <app-icon name="document-text" size="sm" />
              <span>{{ selectedFile()?.name }} ({{ (selectedFile()!.size / 1024).toFixed(1) }} KB)</span>
            </div>
          }

          <div class="bulk-actions">
            <app-button 
              variant="primary"
              [disabled]="bulkEnrolling() || !selectedFile()"
              (clicked)="bulkEnrollStudents()">
              @if (bulkEnrolling()) {
                <app-icon name="arrow-path" size="sm" class="spin" />
              }
              <span>{{ bulkEnrolling() ? 'Đang xử lý...' : 'Gán từ Excel' }}</span>
            </app-button>

            <app-button 
              variant="ghost"
              [disabled]="!selectedFile()"
              (clicked)="clearExcelFile()">
              Xóa file
            </app-button>
          </div>

          <!-- Bulk Results -->
          @if (bulkResult()) {
            <div class="bulk-results">
              <h4 class="results-title">Kết quả xử lý</h4>
              
              <div class="results-stats">
                <div class="stat-card">
                  <div class="stat-value">{{ bulkResult()?.totalProcessed || 0 }}</div>
                  <div class="stat-label">Tổng xử lý</div>
                </div>
                <div class="stat-card success">
                  <div class="stat-value">{{ bulkResult()?.successCount || 0 }}</div>
                  <div class="stat-label">Thành công</div>
                </div>
                <div class="stat-card error">
                  <div class="stat-value">{{ bulkResult()?.errorCount || 0 }}</div>
                  <div class="stat-label">Lỗi</div>
                </div>
              </div>

              @if (bulkResult()?.successfulEnrollments?.length) {
                <div class="results-list success">
                  <h5>Emails thành công:</h5>
                  <div class="emails-list">
                    @for (email of bulkResult()?.successfulEnrollments; track email) {
                      <div class="email-item">✓ {{ email }}</div>
                    }
                  </div>
                </div>
              }

              @if (bulkResult()?.errors?.length) {
                <div class="results-list error">
                  <h5>Emails lỗi:</h5>
                  <div class="emails-list">
                    @for (error of bulkResult()?.errors; track error.email) {
                      <div class="email-item">✗ {{ error.email }}: {{ error.errorMessage }}</div>
                    }
                  </div>
                </div>
              }
            </div>
          }

          @if (bulkSuccess()) {
            <div class="success-alert">
              <app-icon name="check-circle" size="sm" />
              <span>{{ bulkSuccess() }}</span>
            </div>
          }

          @if (bulkError()) {
            <div class="error-alert">
              <app-icon name="exclamation-circle" size="sm" />
              <span>{{ bulkError() }}</span>
            </div>
          }

          <div class="help-text">
            <p>• File Excel cần chứa danh sách email học viên</p>
            <p>• Hệ thống tự động tìm và trích xuất các email hợp lệ</p>
            <p>• Chỉ email đã có tài khoản mới được gán thành công</p>
          </div>
        </div>
          </div>
        }
      </div>

      <!-- Section 4: Enrolled Students -->
      <div class="accordion-item" [class.expanded]="accordionState.enrolledStudents">
        <button 
          type="button"
          class="accordion-header" 
          (click)="toggleAccordion('enrolledStudents')">
          <div class="header-left">
            <app-icon name="academic-cap" size="md" class="header-icon" />
            <h2 class="accordion-title">Danh sách học viên</h2>
          </div>
          <app-icon 
            [name]="accordionState.enrolledStudents ? 'chevron-up' : 'chevron-down'" 
            size="sm" 
            class="chevron-icon" />
        </button>

        @if (accordionState.enrolledStudents) {
          <div class="accordion-content">
            <app-course-students-list [courseId]="c.id" />
          </div>
        }
      </div>

    </div>
  }
</div>
